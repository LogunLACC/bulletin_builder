# Bug Fixes - October 10, 2025

## Summary
Fixed 4 critical bugs discovered during testing of the FrontSteps export feature. All fixes have been committed and tested.

---

## Bug #1: Preview Error - Image URL Query Strings
**Commit:** `ef13d96`  
**Severity:** High (prevented preview from working)

### Problem
Preview rendering failed with `[Errno 22] Invalid argument` when attempting to display images with URLs containing query parameters (e.g., `image.jpg?auto=format&q=75&sharp=10&s=...`).

### Root Cause
`os.path.splitext(url)` was including the entire query string in the file extension, creating invalid temporary file paths on Windows (special characters like `?` and `&` are not allowed in Windows filenames).

### Fix
Modified `download_image()` in `preview.py` to use `urllib.parse.urlparse()` to extract the path before the query string:
```python
from urllib.parse import urlparse
parsed_url = urlparse(url)
path_only = parsed_url.path
ext = os.path.splitext(path_only)[1] or '.png'
ext = ext.split('?')[0].split('&')[0]  # Extra safety
```

Also applied the same fix to `safe_name()` in `scripts/localize_images.py`.

### Testing
- Verified preview renders correctly with query-string URLs
- Tested with both Eventbrite CDN URLs and standard image URLs

---

## Bug #2: FrontSteps Export Dead on Arrival
**Commit:** `2e5ffee`  
**Severity:** Critical (feature completely non-functional)

### Problem
FrontSteps export produced no output or returned mock placeholder content (`"<html><body>Mock Content</body></html>"`).

### Root Cause
- `render_bulletin_html()` in `__main__.py` was just a fallback stub returning mock content
- `collect_context()` method was missing from the app object
- Export handler was calling these methods but they were never properly initialized with real implementations

### Fix
Added real implementations in `core_init.py`:

1. **`render_bulletin_html(ctx: dict) -> str`**
   ```python
   def render_bulletin_html(ctx: dict) -> str:
       """Render bulletin HTML using the template renderer."""
       return app.renderer.render(ctx)
   ```

2. **`collect_context() -> dict`**
   ```python
   def collect_context() -> dict:
       """Collect all context needed for rendering."""
       settings = app.settings_frame.dump() if hasattr(app, 'settings_frame') else {}
       return {
           'title': settings.get('bulletin_title', 'Bulletin'),
           'date': settings.get('bulletin_date', ''),
           'sections': getattr(app, 'sections_data', []),
           'settings': settings
       }
   ```

Also added detailed logging to export handler for debugging.

### Testing
- Verified FrontSteps export produces real HTML content
- Confirmed all bulletin sections are included in export

---

## Bug #3: Validation Dialog Too Long
**Commit:** `fd632f5`  
**Severity:** Medium (usability issue)

### Problem
Export validation dialog displayed hundreds of issues (127+ warnings), making the dialog too long to see the action buttons at the bottom.

### Root Cause
`format_validation_report()` in `export_validator.py` listed every single issue without pagination or limiting.

### Fix
Added `max_issues_per_type` parameter (default: 5) to show only the first few issues per severity level with a summary count:

```python
def format_validation_report(..., max_issues_per_type: int = 5) -> str:
    # ...
    lines.append(f"{severity.upper()} ({len(issues)} total):")
    for issue in issues[:max_issues_per_type]:
        lines.append(f"  • {issue.message}")
        if issue.recommendation:
            lines.append(f"    → {issue.recommendation}")
    if len(issues) > max_issues_per_type:
        lines.append(f"  ... and {len(issues) - max_issues_per_type} more {severity} issues")
```

### Testing
- Verified dialog is now readable with manageable length
- Confirmed total counts are still visible
- Users can see the most important issues first

---

## Bug #4: Images Missing in FrontSteps Export
**Commit:** `c3ebb53` (partial), `8bfb99c` (complete fix)  
**Severity:** Critical (all images removed from export)

### Problem
All images were completely missing from FrontSteps export HTML. Anchor tags around images were empty:
```html
<a href="https://...image.jpg">

</a>
```

### Root Cause Analysis
The issue involved TWO export pipelines:

1. **`frontsteps_postprocess.py`** (regex-based, NOT used) - We initially added picture/source tag handling here
2. **`postprocessors.py`** (BeautifulSoup-based, ACTUAL pipeline) - The real processing happens here

The bug was in the `simplify_buttons()` function in `postprocessors.py`:
- This function collapses "button wrapper" tables to simple text links for FrontSteps compatibility
- It was inadvertently collapsing **event image tables** because they matched the criteria:
  - Single anchor: ✓
  - 2 rows or fewer: ✓ (one for image, one for text)
  - 2 cells or fewer: ✓
- When collapsing, it extracted only text content (`.get_text()`), completely discarding `<img>` tags

### Fix
Added a check to skip table collapse when the anchor contains an image:

```python
# Collapse simple wrapper tables around a single <a>
for table in list(body.find_all('table')):
    anchors = table.find_all('a')
    if len(anchors) == 1 and len(table.find_all('tr')) <= 2 and len(table.find_all('td')) <= 2:
        a = anchors[0]
        
        # Check if anchor contains an image - if so, preserve it
        img = a.find('img')
        if img:
            logger.info(f"Skipping table collapse - anchor contains image: {img.get('src', '')[:60]}")
            continue
        
        # Only collapse button tables (text-only anchors)
        text = a.get_text()
        new_a = soup.new_tag('a', href=a.get('href', ''))
        new_a.string = text or 'More Info'
        new_a['style'] = 'margin:0; padding:0; text-decoration:underline; color:inherit;'
        table.replace_with(new_a)
```

Also added comprehensive logging to both `strip_picture()` and `simplify_buttons()` for debugging.

### Testing
- Verified all 16 images are present in FrontSteps export
- Confirmed both Club Events (8 images) and Community Events (8 images) display correctly
- Button simplification still works for text-only links

---

## Related Files Modified

### `src/bulletin_builder/app_core/preview.py`
- Fixed `download_image()` to handle query strings

### `scripts/localize_images.py`
- Fixed `safe_name()` to handle query strings

### `.gitignore`
- Added `backups/` directory

### `src/bulletin_builder/app_core/core_init.py`
- Added `render_bulletin_html()` method
- Added `collect_context()` method

### `src/bulletin_builder/app_core/exporter.py`
- Added detailed logging to `on_copy_for_frontsteps_clicked()`

### `src/bulletin_builder/app_core/export_validator.py`
- Modified `format_validation_report()` to limit output

### `src/bulletin_builder/postprocess/frontsteps_postprocess.py`
- Added regex patterns for picture/source tags (not actually used in current pipeline)

### `src/bulletin_builder/exporters/postprocessors.py`
- Fixed `simplify_buttons()` to preserve image anchors
- Added logging to `strip_picture()` and `simplify_buttons()`

---

## Impact
All bugs are now resolved, and the FrontSteps export feature is fully functional with:
- ✅ Images properly preserved in export
- ✅ Preview working with all image URL formats
- ✅ Validation dialog showing manageable output
- ✅ Export producing real bulletin content

---

## Next Steps
Continue with **Error Recovery & Resilience** roadmap phase:
- Task 2: Implement draft versioning to allow rollback to previous states
- Task 3: Add error reporting dialog with actionable suggestions
- Task 4: Create recovery mode for startup crashes
- Task 5: Add input validation with clear error messages
- Task 6: Implement graceful degradation for optional features
